var c={};class h{constructor(){this.reviewHistory=[],this.teamPreferences={codingStyle:{},namingConventions:{},approvedPatterns:[],bannedPatterns:[],customRules:[]},this.feedbackHistory=[],this.REQUEST_DELAY_MS=1e3,this.MAX_RETRIES=3,this.INITIAL_RETRY_DELAY_MS=2e3,this.BATCH_SIZE=5,this.lastRequestTime=0,this.apiKey=this.getAPIKey(),console.log("[CodeReviewAI] Initialized")}async reviewCode(e,t){console.log(`[CodeReviewAI] Reviewing ${e.length} files with rate limiting...`);const s={id:this.generateId(),timestamp:new Date,files:[],summary:{issuesFound:0,suggestions:0,criticalIssues:0},overallScore:100};for(let n=0;n<e.length;n++){const i=e[n];t&&t(n+1,e.length,i.path);try{await this.enforceRateLimit();const o=await this.reviewFileWithRetry(i);o.length>0&&s.files.push({path:i.path,comments:o})}catch(o){console.error(`[CodeReviewAI] Failed to review ${i.path} after retries:`,o.message)}(n+1)%10===0&&console.log(`[CodeReviewAI] Progress: ${n+1}/${e.length} files reviewed`)}const r=s.files.flatMap(n=>n.comments);return s.summary.issuesFound=r.length,s.summary.suggestions=r.filter(n=>n.severity==="suggestion").length,s.summary.criticalIssues=r.filter(n=>n.severity==="critical").length,s.overallScore=this.calculateScore(r),this.reviewHistory.push(s),console.log(`[CodeReviewAI] Review complete: ${s.files.length} files with issues found`),s}async enforceRateLimit(){const t=Date.now()-this.lastRequestTime;if(t<this.REQUEST_DELAY_MS){const s=this.REQUEST_DELAY_MS-t;await this.sleep(s)}this.lastRequestTime=Date.now()}async reviewFileWithRetry(e){let t=null;for(let s=0;s<=this.MAX_RETRIES;s++)try{return await this.reviewFile(e)}catch(r){if(t=r,(r.message.includes("429")||r.message.includes("rate limit"))&&s<this.MAX_RETRIES){const n=this.INITIAL_RETRY_DELAY_MS*Math.pow(2,s);console.log(`[CodeReviewAI] Rate limit hit for ${e.path}, retrying in ${n}ms (attempt ${s+1}/${this.MAX_RETRIES})`),await this.sleep(n);continue}if(!r.message.includes("429"))throw r}throw t||new Error("Review failed after retries")}async reviewFile(e){const t=[],s=[".ts",".tsx",".js",".jsx",".py",".java",".cs",".cpp",".c",".h",".go",".rs",".php",".rb",".swift",".kt"],r=e.path.substring(e.path.lastIndexOf(".")).toLowerCase();if(!s.includes(r))return console.log(`[CodeReviewAI] Skipping non-code file: ${e.path}`),t;try{const n=`You are a senior code reviewer. Review this ${e.path} file.

${e.content}

Team preferences:
- Coding style: ${JSON.stringify(this.teamPreferences.codingStyle)}
- Naming conventions: ${JSON.stringify(this.teamPreferences.namingConventions)}
- Approved patterns: ${this.teamPreferences.approvedPatterns.join(", ")}
- Banned patterns: ${this.teamPreferences.bannedPatterns.join(", ")}

Return JSON array of review comments:
[{
  "line": 10,
  "severity": "major",
  "category": "bug",
  "message": "Issue description",
  "suggestion": "How to fix",
  "confidence": 0.9
}]

Focus on: bugs, security issues, performance problems, and violations of team preferences.`,i=await this.callAI(n),o=this.parseAIResponse(i);for(const a of o)t.push({id:this.generateId(),file:e.path,line:a.line,severity:a.severity,category:a.category,message:a.message,suggestion:a.suggestion,codeSnippet:this.extractCodeSnippet(e.content,a.line),confidence:a.confidence||.8})}catch(n){console.error(`[CodeReviewAI] Review failed for ${e.path}:`,n.message)}return t}learnFromFeedback(e,t,s){this.feedbackHistory.push({commentId:e,accepted:t,feedback:s});const r=this.findComment(e);r&&(t?this.reinforcePattern(r):this.suppressPattern(r),console.log(`[CodeReviewAI] Learned from feedback: ${t?"accepted":"rejected"}`))}updatePreferences(e){this.teamPreferences={...this.teamPreferences,...e},console.log("[CodeReviewAI] Team preferences updated")}getReviewHistory(){return[...this.reviewHistory]}getLearningInsights(){const e=this.feedbackHistory.length,t=this.feedbackHistory.filter(i=>i.accepted).length,s=e>0?t/e*100:0,r=new Map;for(const i of this.reviewHistory)for(const o of i.files)for(const a of o.comments){const l=r.get(a.category)||0;r.set(a.category,l+1)}const n=Array.from(r.entries()).map(([i,o])=>({category:i,count:o})).sort((i,o)=>o.count-i.count).slice(0,5);return{totalReviews:this.reviewHistory.length,acceptanceRate:s,topCategories:n,improvedAreas:this.teamPreferences.approvedPatterns}}async callAI(e){if(!this.apiKey)throw new Error("Gemini API key not configured");const t=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:e}]}],generationConfig:{temperature:.3,maxOutputTokens:4e3}})});if(!t.ok){const r=await t.text().catch(()=>"Unknown error");throw new Error(`AI API error (${t.status}): ${r}`)}return(await t.json()).candidates[0].content.parts[0].text}parseAIResponse(e){try{if(!e||typeof e!="string")return[];const s=e.replace(/```json\n?/g,"").replace(/```\n?/g,"").match(/\[[\s\S]*\]/);if(s&&s[0]){const r=JSON.parse(s[0]);return Array.isArray(r)?r:[]}return[]}catch(t){return console.warn("[CodeReviewAI] Failed to parse AI response:",t),[]}}extractCodeSnippet(e,t){if(!e||typeof e!="string")return"";const s=e.split(`
`);if(!s||s.length===0)return"";const r=Math.max(1,Math.min(t||1,s.length)),n=Math.max(0,r-2),i=Math.min(s.length,r+1);return s.slice(n,i).join(`
`)}findComment(e){for(const t of this.reviewHistory)for(const s of t.files){const r=s.comments.find(n=>n.id===e);if(r)return r}return null}reinforcePattern(e){const t=`${e.category}:${e.severity}`;this.teamPreferences.approvedPatterns.includes(t)||this.teamPreferences.approvedPatterns.push(t)}suppressPattern(e){const t=`${e.category}:${e.severity}`;this.teamPreferences.bannedPatterns.includes(t)||this.teamPreferences.bannedPatterns.push(t)}calculateScore(e){if(e.length===0)return 100;const t={critical:20,major:10,minor:5,suggestion:2},s=e.reduce((r,n)=>r+t[n.severity],0);return Math.max(0,100-s)}getAPIKey(){if(typeof process<"u"&&c?.VITE_GEMINI_API_KEY)return c.VITE_GEMINI_API_KEY;if(typeof import.meta<"u")return"AIzaSyDyOsXFR66jNZK4C0u7Za6ev0vvApR8NDg";if(typeof localStorage<"u"){const e=localStorage.getItem("gemini_api_key");if(e)return e}return""}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}sleep(e){return new Promise(t=>setTimeout(t,e))}}function p(){return new h}export{h as CodeReviewAI,p as getCodeReviewAI};
//# sourceMappingURL=CodeReviewAI-4tsfIZHp.js.map
